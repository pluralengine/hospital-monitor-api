'use strict';
const { Pharmacy, User } = require('../models');

module.exports = {
  up: async (queryInterface, Sequelize) => {
    const pharmacies = await Pharmacy.findAll();
    const pharmacyUsers = getUsersFromPharmacies(pharmacies).filter(
      user => user.email && user.email.length > 0
    );
    await User.bulkCreate(pharmacyUsers, {
      options: {
        returning: '*',
      },
    });
  },

  down: async (queryInterface, Sequelize) => {
    const pharmacies = await Pharmacy.findAll();
    const pharmacyUsers = getUsersFromPharmacies(pharmacies);
    return queryInterface.bulkDelete(
      'Users',
      {
        name: {
          [Sequelize.Op.in]: pharmacyUsers.map(
            pharmacyUser => pharmacyUser.name
          ),
        },
      },
      {}
    );
  },
};

function getUsersFromPharmacies(pharmacies) {
  return pharmacies.map(pharmacy => {
    return {
      name: pharmacy.name,
      email: pharmacy.email.toLowerCase(),
      password: pharmacy.centerCode,
      HospitalId: null,
      role: 'Autogenerated Pharmacy Owner',
    };
  });
}

'use strict';
const { User, Pharmacy, Product } = require('../models');

module.exports = {
  up: async (queryInterface, Sequelize) => {
    const autoCreatedUsers = await User.findAll({
      where: { role: 'Autogenerated Pharmacy Owner' },
    });
    const userIds = autoCreatedUsers.map(user => user.id);
    const pharmacies = await Pharmacy.findAll({
      where: { UserId: { [Sequelize.Op.in]: userIds } },
    });
    const maskProduct = await Product.findOne({
      where: { name: 'Mascarilla' },
    });

    return await Promise.all(
      pharmacies.map(pharmacy => pharmacy.addProduct(maskProduct))
    );
  },

  down: async (queryInterface, Sequelize) => {
    const autoCreatedUsers = await User.findAll({
      where: { role: 'Autogenerated Pharmacy Owner' },
    });
    const userIds = autoCreatedUsers.map(user => user.id);
    const pharmacies = await Pharmacy.findAll({
      where: { UserId: { [Sequelize.Op.in]: userIds } },
    });
    const maskProduct = await Product.findOne({
      where: { name: 'Mascarilla' },
    });

    return await Promise.all(
      pharmacies.map(pharmacy => pharmacy.removeProduct(maskProduct))
    );
  },
};
